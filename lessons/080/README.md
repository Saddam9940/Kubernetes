# How to Get Letsencrypt Wildcard Certificate (Using Letsencrypt Nginx DNS Challenge)

[YouTube Tutorial](https://youtu.be/VJPfdXN-dSc)

## Summary
- DNS Challenge Types (HTTP-01, DNS-01, TLS-ALPN-01)
- Renewal requirements (every 60 days, even shorter)
- Reference to the previous video
- DNS records (A, AAAA, CNAME, TXT)
- Nginx - Letsencrypt Architecture Overview
- Mention cert manager for kubernetes
- Combine plugins

## Prerequisites
- Ubuntu 20.04
- Nginx
- Certbot
- Watch this before: How to Secure Nginx with Lets Encrypt on Ubuntu 20.04 with Certbot? - https://youtu.be/R5d-hN9UtpU

## 1. Get Letsencrypt Wildcard Certificate
- Request wildcard certificate
```bash
sudo certbot certonly --manual --preferred-challenges dns --test-cert
```
- Enter `*.devopsbyexample.io`
- Create `TXT` record with following value: `_acme-challenge.devopsbyexample.io.` - `<generated value>`
- [Anycast](https://en.wikipedia.org/wiki/Anycast)
- Verify with dig -t txt 
```bash
dig -t txt +short _acme-challenge.devopsbyexample.io
```
- Press enter
> Certificate is saved at: /etc/letsencrypt/live/devopsbyexample.io/fullchain.pem  
> Key is saved at:         /etc/letsencrypt/live/devopsbyexample.io/privkey.pem

- Decode certificate
```bash
sudo openssl x509 -in /etc/letsencrypt/live/devopsbyexample.io/fullchain.pem -text -noout
```
## 2. Set Up Nginx SSL Wildcard Server Block
- Create folder for website
```bash
sudo mkdir -p /usr/share/devopsbyexample.io/html
```
- Update ownership
```bash
sudo chown -R $USER:$USER /usr/share/devopsbyexample.io/html
```
- Update permissions
```bash
sudo chmod -R 755 /usr/share/devopsbyexample.io
```
- Create `index.html` page
```bash
vi /usr/share/devopsbyexample.io/html/index.html
```
```html
<html>
    <head>
        <title>Welcome!</title>
    </head>
    <body>
        <h1>Wildcard server block is working!</h1>
    </body>
</html>
```
- Create nginx server block
```bash
sudo vi /etc/nginx/conf.d/devopsbyexample.io.conf
```
```conf
server {
    listen 80;

    root /usr/share/devopsbyexample.io/html;
    index index.html;

    server_name *.devopsbyexample.io;

    location / {
            try_files $uri $uri/ =404;
    }
}
```
- Test nginx config
```bash
sudo nginx -t
```
- Reload nginx config
```bash
sudo nginx -s reload
```
- Create `api.devopsbyexample.io` and `hello.devopsbyexample.io` A records
- Try `https://api.devopsbyexample.io/`
- Verify with dig
```bash
dig +short api.devopsbyexample.io
```
```bash
dig +short hello.devopsbyexample.io
```
- Check in the browser http://api.devopsbyexample.io

## 3. Secure Nginx with Lets Encrypt Certificate
- Update nginx config
```bash
sudo vi /etc/nginx/conf.d/devopsbyexample.io.conf
```
```conf
server {
    listen 80;
    server_name *devopsbyexample.io;
    return 301 https://$host$request_uri;
}

server {
    listen              443 ssl;
    ssl_certificate     /etc/letsencrypt/live/devopsbyexample.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/devopsbyexample.io/privkey.pem;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ...
}
```
- Test nginx config
```bash
sudo nginx -t
```
- Fix `server_name`
- Reload nginx config
```bash
sudo nginx -s reload
```
- Go to `https://api.devopsbyexample.io/` and `https://hello.devopsbyexample.io/`

## Links
- [Challenge Types](https://letsencrypt.org/docs/challenge-types/)

## Notes
Depending on your DNS provider, it can be incredibly dangerous to automate certbot/LetsEncrypt renewal via DNS-01 challenges, as the auth token must be available in plaintext and most providers offer too much control via their APIs. A compromised machine could result in all host records being changed, or (with some providers) a change in domain registrant details or even an outright domain transfer.

SSL certificates generated by Let's Encrypt automatically renew every 60 days. This is for two reasons as stated on their blog post:
- They limit damage from key compromise and mis-issuance since stolen keys and mis-issued certificates are valid for a shorter period of time.
- They encourage automation, which is absolutely essential for ease-of-use. This takes the burden off system administrators to manually handle renewals. Once issuance and renewal are automated, shorter lifetimes won’t be any less convenient than longer ones.

For these reasons, we do not offer certificates with lifetimes longer than ninety days. We realize that our service is young, and that automation is new to many subscribers, so we chose a lifetime that allows plenty of time for manual renewal if necessary. We recommend that subscribers renew every sixty days. Once automated renewal tools are widely deployed and working well, we may consider even shorter lifetimes.

Let’s Encrypt CA issues short-lived certificates (90 days). Make sure you renew the certificates at least once in 3 months.

The renew command will take a look at all active certificates and renew those who are close to expiring - which is currently defined as 30 days before the expiration date. If your certificates aren’t due for renewal yet, the client won’t renew them.